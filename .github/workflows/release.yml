name: release

on:
  push:
    branches:
      - master
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Python
      uses: actions/setup-python@v1
      with:
        python-version: 3.8

    - name: Install reqs
      working-directory: ./hamlet-cli
      run: |
        pip install -r requirements/dev.txt
        pip install -e ./

    - name: Create Pre-release build
      if: github.ref == 'refs/heads/master'
      working-directory: ./hamlet-cli
      run: |
        bump2version build

    - name: Get the tag name
      if: startsWith(github.ref, 'refs/tags/')
      id: get_tag_name
      run: echo ::set-output name=TAG_NAME::${GITHUB_REF#refs/tags/}

    - name: Bump Release Version
      if: startsWith(github.ref, 'refs/tags/' )
      working-directory: ./hamlet-cli
      run: |
        bump2version --new-version "${{ steps.get_tag_name.outputs.TAG_NAME }}" release

    - name: Run the compose network
      run: make run

    - name: Run the tests
      run: docker-compose exec -T hamlet-cli /bin/bash -c 'source ~/.bashrc && make tests'

    - name: Create Release
      working-directory: ./hamlet-cli
      run: >-
        python -m
        build
        --sdist
        --wheel
        --outdir dist/
        .

    - name: Publish distribution ðŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@master
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages_dir: hamlet-cli/dist

    - name: Bump to next dev release
      if: startsWith(github.ref, 'refs/tags/' )
      working-directory: ./hamlet-cli
      run: |
        bump2version minor --allow-dirty

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3
      with:
        commit-message: "chore: release bump [skip actions]"
        delete-branch: true
        title: 'chore: update cli package version'
        body: 'Updates the cli version details to align with pyi release'
        labels: 'chore'
        base: 'master'
