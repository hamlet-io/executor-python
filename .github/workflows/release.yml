name: release

on:

  # Workflow run will run after another job has completed
  # so we wait for the workflow to complete then get going
  workflow_run:
    workflows:
      - 'testing'

    branches:
      - 'master'
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

    types:
      - completed

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v1
      with:
        python-version: 3.8

    - name: Install reqs
      run: |
        pip install -r requirements/dev.txt
        pip install -e ./

    - name: Create Release
      run: >-
        python -m build --sdist --wheel --outdir dist/ .

    - name: Publish distribution ðŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@master
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages_dir: dist
